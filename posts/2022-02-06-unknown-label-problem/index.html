<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.280">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Luca Papariello">
<meta name="dcterms.date" content="2022-02-06">
<meta name="description" content="Why turning a multi-class classification task into a multi-label one might be a good idea.">

<title>Luca’s Blog - The unknown label problem</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Luca’s Blog</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/LucaPapariello"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/LPapariello"><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">The unknown label problem</h1>
                  <div>
        <div class="description">
          Why turning a multi-class classification task into a multi-label one might be a good idea.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">fastai</div>
                <div class="quarto-category">computer vision</div>
                <div class="quarto-category">multi-class classification</div>
                <div class="quarto-category">multi-label classification</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Luca Papariello </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 6, 2022</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#multi-class-classification" id="toc-multi-class-classification" class="nav-link" data-scroll-target="#multi-class-classification">Multi-class classification</a>
  <ul class="collapse">
  <li><a href="#constructing-a-datablock-and-dataloaders" id="toc-constructing-a-datablock-and-dataloaders" class="nav-link" data-scroll-target="#constructing-a-datablock-and-dataloaders">Constructing a DataBlock and DataLoaders</a></li>
  <li><a href="#model-training" id="toc-model-training" class="nav-link" data-scroll-target="#model-training">Model training</a></li>
  </ul></li>
  <li><a href="#multi-label-classification" id="toc-multi-label-classification" class="nav-link" data-scroll-target="#multi-label-classification">Multi-label classification</a>
  <ul class="collapse">
  <li><a href="#constructing-a-datablock-and-dataloaders-1" id="toc-constructing-a-datablock-and-dataloaders-1" class="nav-link" data-scroll-target="#constructing-a-datablock-and-dataloaders-1">Constructing a DataBlock and DataLoaders</a></li>
  <li><a href="#model-training-1" id="toc-model-training-1" class="nav-link" data-scroll-target="#model-training-1">Model training</a></li>
  </ul></li>
  <li><a href="#acknowledgements-and-references" id="toc-acknowledgements-and-references" class="nav-link" data-scroll-target="#acknowledgements-and-references">Acknowledgements and references</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<div class="quarto-figure quarto-figure-right">
<figure class="figure">
<p><a href="https://www.kaggle.com/code/lucapapariello/the-unknown-label-problem"><img src="https://kaggle.com/static/images/open-in-kaggle.svg" class="img-fluid figure-img"></a></p>
</figure>
</div>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>We often train machine learning models to assign samples to a class. Take for instance the <a href="http://yann.lecun.com/exdb/mnist/">MNIST</a> dataset, where images of handwritten digits between 0 and 9 have to be assigned to <em>one</em> of 10 possible classes. Another example, and this is the dataset we’ll consider in this post, is the <a href="http://www.robots.ox.ac.uk/~vgg/data/pets/">Oxford-IIIT Pet Dataset</a>, which contains more than 7000 images of cats and dogs from 37 different breeds. Our goal is to assign the right breed to each image. The scenario just described is typically approached as a <a href="https://en.wikipedia.org/wiki/Multiclass_classification">multi-class classification</a> problem, in which samples have to be assigned to <em>one</em> of <span class="math inline">\(N\)</span> possible classes.</p>
<p>Let’s say we have already trained our pet breed classifier and want to roll it out so that other people can interact with it. In such an environment no one can prevent a user from loading an image that does not belong to <em>any</em> of the classes known to our model. And even if someone were to do so, our model would still return one of the 37 breeds—it has no ability to say “it’s none of the breeds I know”. Our goal is to create a model that can do just that!</p>
<p>Although this seems to be a fairly common problem, I have seen many people struggling to find a solution. One might be tempted to add an additional class (let’s call it <em>is_other</em>) to which all samples that do not contain any instance of a known class will be assigned. However, as Jeremy Howard explains in one of the lectures of his course <a href="https://course19.fast.ai/part2">Deep Learning from the Foundations</a>, this is not a great idea. The main reason is that our model would have to learn the features that distinguish the negative of every other class we are interested in. An approach that might work better instead is to treat our problem as if it were a multi-label classification task.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>You can reproduce all the results presented below by directly accessing the notebook used to create this post or by clicking the Kaggle badge at the top of the page. In any case, make sure you have access to a GPU. This speeds up the execution time considerably!</p>
</div>
</div>
</section>
<section id="multi-class-classification" class="level1">
<h1>Multi-class classification</h1>
<p>The dataset can easily be downloaded using the fastai’s <code>untar_data</code> function, which downloads and extracts it for us (if not already available). This function returns a <code>pathlib.Path</code> object.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:45,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1644756711581,&quot;user&quot;:{&quot;displayName&quot;:&quot;Luca Papariello&quot;,&quot;photoUrl&quot;:&quot;https://lh3.googleusercontent.com/a/default-user=s64&quot;,&quot;userId&quot;:&quot;06264924592179706118&quot;},&quot;user_tz&quot;:-60}" data-execution_count="2">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> untar_data(URLs.PETS)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>All images are stored in the <em>images</em> subdirectory. To collect all filenames, we can use the fastai’s <code>get_image_files</code> function. This function recursively gets all the image files in the given path and returns an <a href="https://fastcore.fast.ai/foundation.html#L"><code>L</code> object</a>, which is a sort of Python list on steroids.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:47,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1644756711590,&quot;user&quot;:{&quot;displayName&quot;:&quot;Luca Papariello&quot;,&quot;photoUrl&quot;:&quot;https://lh3.googleusercontent.com/a/default-user=s64&quot;,&quot;userId&quot;:&quot;06264924592179706118&quot;},&quot;user_tz&quot;:-60}" data-outputid="fafe06c4-1502-4501-d878-47ea3e272653" data-execution_count="4">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get image files in `path/images`</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>fns <span class="op">=</span> get_image_files(path<span class="op">/</span><span class="st">"images"</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>fns[:<span class="dv">3</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>(#3) [Path('images/Egyptian_Mau_167.jpg'),Path('images/pug_52.jpg'),Path('images/basset_hound_112.jpg')]</code></pre>
</div>
</div>
<p>We can see that the pet breed is part of the filename. Next, we’ll use <strong>regular expressions</strong> to extract it so that it can then be used as target label for our model.</p>
<section id="constructing-a-datablock-and-dataloaders" class="level2">
<h2 class="anchored" data-anchor-id="constructing-a-datablock-and-dataloaders">Constructing a DataBlock and DataLoaders</h2>
<p>Those already familiar with PyTorch know that there are two main classes for accessing a dataset: the <code>Dataset</code> and <code>DataLoader</code>. On top of that, fastai offers two classes, the <code>Datasets</code> and <code>DataLoaders</code>, for bringing traning and validation <code>Dataset</code>s and <code>DataLoader</code>s together.</p>
<p>We’ll now create a <code>DataBlock</code>, which is sort of template for creating a DataLoaders later on. Here is the code, with an explanation of each line immediately afterwards.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:39,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1644756711592,&quot;user&quot;:{&quot;displayName&quot;:&quot;Luca Papariello&quot;,&quot;photoUrl&quot;:&quot;https://lh3.googleusercontent.com/a/default-user=s64&quot;,&quot;userId&quot;:&quot;06264924592179706118&quot;},&quot;user_tz&quot;:-60}" data-execution_count="6">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>name_regex <span class="op">=</span> <span class="vs">r"(.+)_\d+\.jpg$"</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>dblock <span class="op">=</span> DataBlock(</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>(ImageBlock, CategoryBlock),</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    get_items<span class="op">=</span>get_image_files,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    splitter<span class="op">=</span>RandomSplitter(seed<span class="op">=</span><span class="dv">42</span>),</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    get_y<span class="op">=</span>using_attr(RegexLabeller(name_regex), attr<span class="op">=</span><span class="st">'name'</span>),</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>Resize(<span class="dv">460</span>),</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>aug_transforms(size<span class="op">=</span><span class="dv">224</span>, min_scale<span class="op">=</span><span class="fl">0.75</span>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>First, we need to specify what data we are working with. Our <em>independent</em> variables are images (hence <code>ImageBlock</code>), while our <em>dependent</em> variables are labels (hence <code>CategoryBlock</code>, which returns a single integer). Second, we need to tell fastai how to get the list of items in our dataset. As we saw before, the function <code>get_image_files</code> does exactly that. We then decide to split our data randomly, which is what the <code>RandomSplitter</code> does. By default, it keeps 80% of the data for training and puts the remaining 20% in the validation set. The DataBlock now knows how go get and split data, but it doesn’t know how to label these items. We specify this with the <code>get_y</code> argument. A handy class to label samples with regular expressions is <code>RegexLabeller</code>. Note that we cannot pass items directly to it as they are—the elements in <code>fns</code> are pathlib.Path objects, not strings (see above)—but we have to use the <code>.name</code> attribute. This is what <code>using_attr</code> does. Lastly, we resize every image to the same size (460 x 460 pixels) so that we can apply data augmentation to batches on the GPU.</p>
<p>We can now build our DataLoaders! But before moving on, we want to make sure that things have gone as planned. To do so, we’ll check out a few samples.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:2162,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1644754841657,&quot;user&quot;:{&quot;displayName&quot;:&quot;Luca Papariello&quot;,&quot;photoUrl&quot;:&quot;https://lh3.googleusercontent.com/a/default-user=s64&quot;,&quot;userId&quot;:&quot;06264924592179706118&quot;},&quot;user_tz&quot;:-60}" data-outputid="fad8125c-0175-4adf-a9cd-deae9a2fce65" data-execution_count="8">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create DataLoaders</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> dblock.dataloaders(path<span class="op">/</span><span class="st">"images"</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>dls.show_batch(nrows<span class="op">=</span><span class="dv">1</span>, ncols<span class="op">=</span><span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-8-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="model-training" class="level2">
<h2 class="anchored" data-anchor-id="model-training">Model training</h2>
<p>Once we are convinced that our data have been prepared correctly, we can proceed with the creation of a deep learning model. We’re going to keep things simple here as we want the training to be short. For this reason, we’ll proceed with a <strong>ResNet18</strong> model, which is a pretty small Convolutional Neural Network (CNN) by today’s standards.</p>
<p>The <em>learning rate</em> is one of the hyperparameters that has the greatest influence on the training of neural networks. Practitioners usually set it to a value they like or tune it via hyperparameter sweeps. fastai provides us with the <code>lr_find</code> method, which implements a version of the <strong>learning rate finder</strong> originally proposed by Leslie Smith.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:72563,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1644478587115,&quot;user&quot;:{&quot;displayName&quot;:&quot;Luca Papariello&quot;,&quot;photoUrl&quot;:&quot;https://lh3.googleusercontent.com/a/default-user=s64&quot;,&quot;userId&quot;:&quot;06264924592179706118&quot;},&quot;user_tz&quot;:-60}" data-outputid="3361b002-cb4e-4602-d5d8-8c3696dfa857">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create CNN model (ResNet18)</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> cnn_learner(dls, resnet18, metrics<span class="op">=</span>[error_rate, accuracy])</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>learn.lr_find(start_lr<span class="op">=</span><span class="fl">1e-6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>SuggestedLRs(valley=0.0014125375309959054)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-9-output-3.png" class="img-fluid"></p>
</div>
</div>
<p>We opt for an aggressive value for the learning rate, which allows us to train the model for a small number of epochs. We’ll train the model’s head for 1 epoch, while keeping the rest of the weights frozen; then we unfreeze all the weights and continue the training for 4 more epochs.</p>
<p>All this is packaged in the <code>fine_tune</code> method.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:447857,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1644479288667,&quot;user&quot;:{&quot;displayName&quot;:&quot;Luca Papariello&quot;,&quot;photoUrl&quot;:&quot;https://lh3.googleusercontent.com/a/default-user=s64&quot;,&quot;userId&quot;:&quot;06264924592179706118&quot;},&quot;user_tz&quot;:-60}" data-outputid="4c3a40e5-a867-4fdd-b153-4b74506f8ead">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fine-tune model</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>learn.fine_tune(<span class="dv">4</span>, base_lr<span class="op">=</span><span class="fl">3e-3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>error_rate</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1.403973</td>
      <td>0.382155</td>
      <td>0.121110</td>
      <td>0.878890</td>
      <td>01:25</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>error_rate</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.518523</td>
      <td>0.352880</td>
      <td>0.117050</td>
      <td>0.882950</td>
      <td>01:29</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.456349</td>
      <td>0.321530</td>
      <td>0.097429</td>
      <td>0.902571</td>
      <td>01:34</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.308262</td>
      <td>0.233842</td>
      <td>0.072395</td>
      <td>0.927605</td>
      <td>01:29</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.176608</td>
      <td>0.223449</td>
      <td>0.065629</td>
      <td>0.934371</td>
      <td>01:29</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<p>We can already see from this table that the training was quite successful—the error rate is less than 7%. We can now take a look at some predictions on the validation set, which can be obtained through the method <code>show_results</code>.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:2275,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1644479355323,&quot;user&quot;:{&quot;displayName&quot;:&quot;Luca Papariello&quot;,&quot;photoUrl&quot;:&quot;https://lh3.googleusercontent.com/a/default-user=s64&quot;,&quot;userId&quot;:&quot;06264924592179706118&quot;},&quot;user_tz&quot;:-60}" data-outputid="0d187104-c51f-410b-87ce-0c622b0cd721">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Display couple of results</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>learn.show_results(max_n<span class="op">=</span><span class="dv">5</span>, nrows<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-11-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Now that we are confident enough that our model is working well, we can put it to the test by passing it some pictures found on the web. Let’s start with the image of a <a href="https://www.zooplus.it/magazine/wp-content/uploads/2018/05/AdobeStock_219606483-768x512-1.jpeg">cat</a> whose breed is known to our model and see how it behaves.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:504,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1644758067177,&quot;user&quot;:{&quot;displayName&quot;:&quot;Luca Papariello&quot;,&quot;photoUrl&quot;:&quot;https://lh3.googleusercontent.com/a/default-user=s64&quot;,&quot;userId&quot;:&quot;06264924592179706118&quot;},&quot;user_tz&quot;:-60}" data-outputid="b60d0ce4-12ee-434a-e977-59c7f474a89e" data-execution_count="37">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>img_cat <span class="op">=</span> PILImage.create(<span class="st">'maine_coon.jpeg'</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>img_cat.show()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-13-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:842,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1644479684259,&quot;user&quot;:{&quot;displayName&quot;:&quot;Luca Papariello&quot;,&quot;photoUrl&quot;:&quot;https://lh3.googleusercontent.com/a/default-user=s64&quot;,&quot;userId&quot;:&quot;06264924592179706118&quot;},&quot;user_tz&quot;:-60}" data-outputid="61b6f8b2-46e5-4b8a-f7b4-c8622eb496df">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>learn.predict(img_cat)[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>'Maine_Coon'</code></pre>
</div>
</div>
<p>The model correctly predicts that it is a maine coon cat—so far so good! Let’s try now with a picture of something it has never seen before, for example an <a href="https://media.istockphoto.com/photos/background-elephant-picture-id479667835?k=20&amp;m=479667835&amp;s=612x612&amp;w=0&amp;h=Zy5JdCC9SqOL2Tf5SHSM0VdjaKdn2xt_jZi8SOy-USY=">elephant</a>?</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:562,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1644758094770,&quot;user&quot;:{&quot;displayName&quot;:&quot;Luca Papariello&quot;,&quot;photoUrl&quot;:&quot;https://lh3.googleusercontent.com/a/default-user=s64&quot;,&quot;userId&quot;:&quot;06264924592179706118&quot;},&quot;user_tz&quot;:-60}" data-outputid="0ab7ccad-1576-4172-ccce-1d18a5285c01" data-execution_count="39">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>img_el <span class="op">=</span> PILImage.create(<span class="st">'elephant.jpg'</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>img_el.show()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-15-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:214,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1644479739007,&quot;user&quot;:{&quot;displayName&quot;:&quot;Luca Papariello&quot;,&quot;photoUrl&quot;:&quot;https://lh3.googleusercontent.com/a/default-user=s64&quot;,&quot;userId&quot;:&quot;06264924592179706118&quot;},&quot;user_tz&quot;:-60}" data-outputid="74eb791f-fc03-4126-f919-51fab13444ce">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>learn.predict(img_el)[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>'British_Shorthair'</code></pre>
</div>
</div>
<p>Here the model tells us that it is a british shorthair cat. Instead, we would like the model to tell us when it doesn’t know something. However, the current model has no way of doing this because it was built that way. Note that when we’ve instantiated our <code>Learner</code> above, we didn’t specify what loss function to use. This is because fastai is smart enough to select the right one for us, which in this case is the <strong>cross-entropy</strong> loss. Also, to turn the activations into actual predictions, the last layer uses the <strong>softmax</strong> activation function. By construction, the softmax really wants to pick <em>one</em> class among the available—after all, the outputs of a softmax layer have to add up to 1 and the largest activation value is magnified even more. In the next section, we will see how by reformulating the problem we can achieve the desired behavior.</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you have not set the loss function yourself and you are unsure of what fastai has chosen for you, you can always inspect the <code>.loss_func</code> attribute of your <code>Learner</code>.</p>
</div>
</div>
</section>
</section>
<section id="multi-label-classification" class="level1">
<h1>Multi-label classification</h1>
<p>We’ll now go back to the beginning and reformulate the pet breeds classification problem as a multi-label classification task. In this way, we should be able to tell if an image does <em>not</em> belong to any of the breeds seen during training.</p>
<section id="constructing-a-datablock-and-dataloaders-1" class="level2">
<h2 class="anchored" data-anchor-id="constructing-a-datablock-and-dataloaders-1">Constructing a DataBlock and DataLoaders</h2>
<p>In the multi-class case, we used the <code>CategoryBlock</code>, while here we’ll switch to the <code>MultiCategoryBlock</code>, which returns a <em>one-hot encoded</em> vector. This block expects a <em>list</em> of labels (strings), hence we need to modify a bit the <code>get_y</code> function, which was only returning the pet breed as a string. The next cell defines this function, builds new DataBlock and DataLoaders, and displays a few samples.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:1863,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1644756874692,&quot;user&quot;:{&quot;displayName&quot;:&quot;Luca Papariello&quot;,&quot;photoUrl&quot;:&quot;https://lh3.googleusercontent.com/a/default-user=s64&quot;,&quot;userId&quot;:&quot;06264924592179706118&quot;},&quot;user_tz&quot;:-60}" data-outputid="39e67b32-26a8-4eed-9343-85621c74234a" data-execution_count="11">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_y(fp):</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Get list of labels from df."""</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    lbl <span class="op">=</span> using_attr(RegexLabeller(name_regex), attr<span class="op">=</span><span class="st">"name"</span>)(fp)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [lbl]</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>dblock <span class="op">=</span> DataBlock(</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>(ImageBlock, MultiCategoryBlock),</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    get_items<span class="op">=</span>get_image_files,</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    splitter<span class="op">=</span>RandomSplitter(seed<span class="op">=</span><span class="dv">42</span>),</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    get_y<span class="op">=</span>get_y,</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>Resize(<span class="dv">460</span>),</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>aug_transforms(size<span class="op">=</span><span class="dv">224</span>, min_scale<span class="op">=</span><span class="fl">0.75</span>),</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> dblock.dataloaders(path<span class="op">/</span><span class="st">"images"</span>)</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>dls.show_batch(nrows<span class="op">=</span><span class="dv">1</span>, ncols<span class="op">=</span><span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-17-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="model-training-1" class="level2">
<h2 class="anchored" data-anchor-id="model-training-1">Model training</h2>
<p>Before creating a new model and launching the learning rate finder, we’d like to point out some differences in relation to what we have done above. First, even if we don’t do so explicitly, fastai will again choose the correct loss function for us, which in this case is the <strong>binary cross-entropy</strong> loss. The activation function of the final layer is no longer the softmax, rather the <strong>sigmoid</strong> function. The outputs of this layer therefore no longer have to add up to one, but each neuron can return a value between 0 and 1 regardless of the others. This means that we also need to adapt our metric. In the multi-class case, the accuracy was comparing the target label with the class with highest activation (via <code>argmax</code>). But now these activations might even be all 1 in theory, or all 0. We hence need to pick a threshold to decide what has to be set to 0 and what to 1. This is what <code>accuracy_multi</code> does.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:78304,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1644757142992,&quot;user&quot;:{&quot;displayName&quot;:&quot;Luca Papariello&quot;,&quot;photoUrl&quot;:&quot;https://lh3.googleusercontent.com/a/default-user=s64&quot;,&quot;userId&quot;:&quot;06264924592179706118&quot;},&quot;user_tz&quot;:-60}" data-outputid="3bb7b93f-7f47-4cee-8796-a7c94875c4ee" data-execution_count="29">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create CNN model (ResNet18)</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> cnn_learner(dls, resnet18, metrics<span class="op">=</span>partial(accuracy_multi, thresh<span class="op">=</span><span class="fl">0.7</span>))</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>learn.lr_find(start_lr<span class="op">=</span><span class="fl">1e-6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="29">
<pre><code>SuggestedLRs(valley=0.003162277629598975)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-18-output-3.png" class="img-fluid"></p>
</div>
</div>
<p>We choose again a learning rate value large enough to have a reasonably fast training and launch it.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:462386,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1644757639328,&quot;user&quot;:{&quot;displayName&quot;:&quot;Luca Papariello&quot;,&quot;photoUrl&quot;:&quot;https://lh3.googleusercontent.com/a/default-user=s64&quot;,&quot;userId&quot;:&quot;06264924592179706118&quot;},&quot;user_tz&quot;:-60}" data-outputid="97e34b23-e273-4dfc-a89d-19b7ef3808bb" data-execution_count="30">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fine-tune model</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>learn.fine_tune(<span class="dv">4</span>, base_lr<span class="op">=</span><span class="fl">1e-2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy_multi</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.319909</td>
      <td>0.029859</td>
      <td>0.981696</td>
      <td>01:30</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy_multi</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.034611</td>
      <td>0.028626</td>
      <td>0.986578</td>
      <td>01:33</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.030179</td>
      <td>0.023405</td>
      <td>0.988754</td>
      <td>01:33</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.018344</td>
      <td>0.015487</td>
      <td>0.992576</td>
      <td>01:32</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.010457</td>
      <td>0.013025</td>
      <td>0.993472</td>
      <td>01:32</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<p>The results seem promising, so we move on and display a few predictions on the validation set.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:2076,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1644757937626,&quot;user&quot;:{&quot;displayName&quot;:&quot;Luca Papariello&quot;,&quot;photoUrl&quot;:&quot;https://lh3.googleusercontent.com/a/default-user=s64&quot;,&quot;userId&quot;:&quot;06264924592179706118&quot;},&quot;user_tz&quot;:-60}" data-outputid="71793ad5-8264-48ea-f3a7-74619a9bc835" data-execution_count="32">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Display couple of results</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>learn.show_results(max_n<span class="op">=</span><span class="dv">5</span>, nrows<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-20-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>The crucial moment is approaching: we want to see how the model behaves when we show it new pictures and, in particular, pictures depicting things it doesn’t know. We hence repeat the previous experiment by passing it the image of a cat.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:219,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1644758075348,&quot;user&quot;:{&quot;displayName&quot;:&quot;Luca Papariello&quot;,&quot;photoUrl&quot;:&quot;https://lh3.googleusercontent.com/a/default-user=s64&quot;,&quot;userId&quot;:&quot;06264924592179706118&quot;},&quot;user_tz&quot;:-60}" data-outputid="b0633e19-5cbd-47db-f145-eee1222d716e" data-execution_count="38">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Increase threshold, i.e. assign a label only when very confident.</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>learn.loss_func <span class="op">=</span> BCEWithLogitsLossFlat(thresh<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>learn.predict(img_cat)[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="38">
<pre><code>(#1) ['Maine_Coon']</code></pre>
</div>
</div>
<p>All good for now, it correctly predicts that it’s a maine coon. But what about the image of the elephant?</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:311,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1644758104140,&quot;user&quot;:{&quot;displayName&quot;:&quot;Luca Papariello&quot;,&quot;photoUrl&quot;:&quot;https://lh3.googleusercontent.com/a/default-user=s64&quot;,&quot;userId&quot;:&quot;06264924592179706118&quot;},&quot;user_tz&quot;:-60}" data-outputid="ae9bef2d-873d-4f49-d8c6-2437c7736520" data-execution_count="40">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>learn.predict(img_el)[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="40">
<pre><code>(#0) []</code></pre>
</div>
</div>
<p>Great! Our model doesn’t recognise the content of this picture and hence doesn’t return any label! 🎉</p>
</section>
</section>
<section id="acknowledgements-and-references" class="level1">
<h1>Acknowledgements and references</h1>
<p>This post is inspired by the fantastic course <a href="https://course.fast.ai/">Practical Deep Learning for Coders</a> taught at fast.ai and the material kindly provided by Zachary Mueller through the <a href="https://walkwithfastai.com/">Walk with fastai</a> project.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>